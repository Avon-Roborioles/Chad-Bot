#!/usr/bin/env sh

read -p "[?] - Proceed to commit the changes? (y/n) ... " proceed_to_commit

if [ "${proceed_to_commit}" = "y" ]; then
	echo
	bash ./.husky/scripts/commit-to-public.sh
	echo
else
	echo
fi


cd des

version_tag="latest"

latest_hash=$(git rev-parse --short HEAD)
timestamp=$(node -e "console.log(Date.now())")

current_version=$(node -e "const content = JSON.parse(require('fs').readFileSync('./package.json')); console.log(content.version)")


cd ..


echo "[?] - What's the version of package to publish?"
echo "[?] - Specify '-dev' at the end of version to publish as 'dev' version."
echo

read -p "[?] Version to upload ($current_version): " package_version

if [ "${package_version}" = "" ]; then
	package_version=$current_version
fi


is_version_dev() {
	node -e "'$package_version'.endsWith('-dev') ? process.exit(0) : process.exit(1)"
}


version_to_upload=$package_version

if is_version_dev; then
	version_to_upload="${package_version}.${latest_hash}.${timestamp}"
	version_tag="dev"
fi


read -p "[?] Uploading version v$version_to_upload with tag '$version_tag'. Continue? (y) ... "

node -e "const content = JSON.parse(require('fs').readFileSync('./package.json')); content.version = '$version_to_upload'; require('fs').writeFileSync('./package.json', JSON.stringify(content, null, '\t'))"
cp ./package.json ./mongodb/package.json


npm publish --tag "$version_tag"

echo
echo 'Done!'

exit 0
